name: Package and Publish Helm Chart

on:
  push:
    branches:
      - main
    paths:
      - 'ks-gateway-autodns-server/helm-chart/**'
      - '.github/workflows/helm-release.yml'

jobs:
  release:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
      
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: Configure Git
      run: |
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"
        
    - name: Install Helm
      uses: azure/setup-helm@v4
      with:
        version: 'latest'
        
    - name: Package Helm Chart
      run: |
        cd ks-gateway-autodns-server/helm-chart
        helm package ks-gateway-autodns-server
        
    - name: Checkout gh-pages branch
      uses: actions/checkout@v4
      with:
        ref: gh-pages
        path: gh-pages
        
    - name: Update Helm repository
      run: |
        mkdir -p gh-pages/charts
        cp ks-gateway-autodns-server/helm-chart/*.tgz gh-pages/charts/
        cd gh-pages
        helm repo index charts --url https://annopick.github.io/ks-gateway-autodns/charts
        
    - name: Commit and push changes
      run: |
        cd gh-pages
        git add charts/
        git commit -m "Update Helm chart repository" || exit 0
        git push
